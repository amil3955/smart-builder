// src/utils/dxfExport.js
/**
 * dxfExport.js - Utilities for exporting panel models to DXF format
 * 
 * This file contains functions for converting 3D model geometry to DXF format
 * for compatibility with CAD software.
 */

import * as THREE from 'three';

/**
 * Main export function - converts panels to DXF format and triggers download
 * 
 * @param {Array} panels - Array of panel objects with their properties
 * @param {String} filename - Name for the exported file
 * @returns {Boolean} - Success status of the export
 */
export const exportToDXF = (panels, filename = 'panel_export.dxf') => {
  try {
    // Create the DXF content
    let dxfContent = createDXFHeader();
    
    // Add each panel to the DXF content
    panels.forEach(panel => {
      const { type, label, position, rotation, size, thickness } = panel;
      
      if (type === 'square') {
        dxfContent += createSquarePanelDXF(label, position, rotation, size, thickness);
      } else if (type === 'pentagon') {
        dxfContent += createPentagonPanelDXF(label, position, rotation, size, thickness);
      }
    });
    
    // Add the DXF footer
    dxfContent += createDXFFooter();
    
    // Create and trigger download
    downloadDXF(dxfContent, filename);
    
    return true;
  } catch (error) {
    console.error("Error exporting DXF:", error);
    return false;
  }
};

/**
 * Extract panel data from Model component
 * 
 * @returns {Array} - Array of panel data objects
 */
export const extractPanelData = () => {
  return [
    {
      id: "panel1",
      type: 'square',
      label: 'EX-1',
      position: [0, 5, -1.3],
      rotation: [Math.PI / 2, 0, 0],
      size: 10,
      thickness: 0.3
    },
    {
      id: "panel2",
      type: 'square',
      label: 'EX-3',
      position: [0, -4.7, -1.3],
      rotation: [Math.PI / 2, 0, 0],
      size: 10,
      thickness: 0.3
    },
    {
      id: "panel3",
      type: 'pentagon',
      label: 'EX-2',
      position: [4.7, 0, 0],
      rotation: [0, Math.PI / 2, Math.PI / 2],
      size: 10,
      thickness: 0.3
    },
    {
      id: "panel4",
      type: 'pentagon',
      label: 'EX-4',
      position: [-5, 0, 0],
      rotation: [0, Math.PI / 2, Math.PI / 2],
      size: 10,
      thickness: 0.3
    }
  ];
};

/**
 * Create the DXF file header
 * 
 * @returns {String} - DXF header section
 */
export const createDXFHeader = () => {
  return `999
Dxf file generated by netDxf https://github.com/haplokuon/netDxf, Copyright(C) 2009-2018 Daniel Carvajal, Licensed under LGPL
0
SECTION
2
HEADER
9
$ACADVER
1
AC1015
9
$DWGCODEPAGE
3
ANSI_1252
9
$HANDSEED
5
5D
9
$ANGBASE
50
0.0
9
$ANGDIR
70
0
9
$ATTMODE
70
1
9
$AUNITS
70
0
9
$AUPREC
70
0
9
$CECOLOR
62
256
9
$CELTSCALE
40
1.0
9
$CELTYPE
6
ByLayer
9
$CELWEIGHT
370
-1
9
$CLAYER
8
0
9
$CMLJUST
70
0
9
$CMLSCALE
40
20.0
9
$CMLSTYLE
2
Standard
9
$DIMSTYLE
2
Standard
9
$TEXTSIZE
40
2.5
9
$TEXTSTYLE
7
Standard
9
$LUNITS
70
2
9
$LUPREC
70
4
9
$EXTNAMES
290
1
9
$INSBASE
10
0.0
20
0.0
30
0.0
9
$INSUNITS
70
0
9
$LTSCALE
40
1.0
9
$LWDISPLAY
290
0
9
$PDMODE
70
0
9
$PDSIZE
40
0.0
9
$PLINEGEN
70
0
9
$PSLTSCALE
70
1
9
$TDCREATE
40
2460810.25255953
9
$TDUCREATE
40
2460810.25255953
9
$TDUPDATE
40
2460810.25255953
9
$TDUUPDATE
40
2460810.25255953
9
$TDINDWG
40
0.0
9
$UCSORG
10
0.0
20
0.0
30
0.0
9
$UCSXDIR
10
1.0
20
0.0
30
0.0
9
$UCSYDIR
10
0.0
20
1.0
30
0.0
9
$DIMADEC
70
0
9
$DIMALT
70
0
9
$DIMALTD
70
2
9
$DIMALTF
40
25.4
9
$DIMALTRND
40
0.0
9
$DIMALTTD
70
2
9
$DIMALTTZ
70
0
9
$DIMALTU
70
2
9
$DIMALTZ
70
0
9
$DIMAPOST
1
[]
9
$DIMATFIT
70
3
9
$DIMAUNIT
70
0
9
$DIMASZ
40
0.18
9
$DIMAZIN
70
0
9
$DIMSAH
70
0
9
$DIMBLK
1

9
$DIMLDRBLK
1

9
$DIMCEN
40
0.09
9
$DIMCLRD
70
0
9
$DIMCLRE
70
0
9
$DIMCLRT
70
0
9
$DIMDEC
70
4
9
$DIMDLE
40
0.0
9
$DIMDLI
40
0.38
9
$DIMDSEP
70
46
9
$DIMEXE
40
0.18
9
$DIMEXO
40
0.0625
9
$DIMFXLON
70
0
9
$DIMFXL
40
1.0
9
$DIMGAP
40
0.09
9
$DIMJUST
70
0
9
$DIMLFAC
40
1.0
9
$DIMLUNIT
70
2
9
$DIMLWD
70
-2
9
$DIMLWE
70
-2
9
$DIMPOST
1
<>
9
$DIMRND
40
0.0
9
$DIMSCALE
40
1.0
9
$DIMSD1
70
0
9
$DIMSD2
70
0
9
$DIMSE1
70
0
9
$DIMSE2
70
0
9
$DIMSOXD
70
1
9
$DIMTAD
70
0
9
$DIMTDEC
70
4
9
$DIMTFAC
40
1.0
9
$DIMTIH
70
0
9
$DIMTIX
70
0
9
$DIMTM
40
0.0
9
$DIMTMOVE
70
0
9
$DIMTOFL
70
0
9
$DIMTOH
70
0
9
$DIMTOL
70
0
9
$DIMLIM
70
0
9
$DIMTOLJ
70
1
9
$DIMTP
40
0.0
9
$DIMTXT
40
0.18
9
$DIMTXTDIRECTION
70
0
9
$DIMTZIN
70
0
9
$DIMZIN
70
0
9
$DIMFRAC
70
0
9
$DIMLTYPE
6
ByBlock
9
$DIMLTEX1
6
ByBlock
9
$DIMLTEX2
6
ByBlock
0
ENDSEC
0
SECTION
2
CLASSES
0
CLASS
1
RASTERVARIABLES
2
AcDbRasterVariables
3
ISM
90
0
280
0
281
0
0
ENDSEC
0
SECTION
2
TABLES
0
TABLE
2
APPID
5
4
330
0
100
AcDbSymbolTable
70
4
0
APPID
5
18
330
4
100
AcDbSymbolTableRecord
100
AcDbRegAppTableRecord
2
ACAD
70
0
0
APPID
5
52
330
4
100
AcDbSymbolTableRecord
100
AcDbRegAppTableRecord
2
AcCmTransparency
70
0
0
APPID
5
53
330
4
100
AcDbSymbolTableRecord
100
AcDbRegAppTableRecord
2
GradientColor1ACI
70
0
0
APPID
5
54
330
4
100
AcDbSymbolTableRecord
100
AcDbRegAppTableRecord
2
GradientColor2ACI
70
0
0
ENDTAB
0
TABLE
2
VPORT
5
1
330
0
100
AcDbSymbolTable
70
1
0
VPORT
5
2
330
1
100
AcDbSymbolTableRecord
100
AcDbViewportTableRecord
2
*Active
70
0
10
0.0
20
0.0
11
1.0
21
1.0
12
0.0
22
0.0
13
0.0
23
0.0
14
0.5
24
0.5
15
10.0
25
10.0
16
0.0
26
0.0
36
1.0
17
0.0
27
0.0
37
0.0
40
10.0
41
1.0
75
0
76
1
0
ENDTAB
0
TABLE
2
LTYPE
5
6
330
0
100
AcDbSymbolTable
70
3
0
LTYPE
5
14
330
6
100
AcDbSymbolTableRecord
100
AcDbLinetypeTableRecord
2
Continuous
70
0
3
Solid line
72
65
73
0
40
0.0
0
LTYPE
5
15
330
6
100
AcDbSymbolTableRecord
100
AcDbLinetypeTableRecord
2
ByLayer
70
0
3

72
65
73
0
40
0.0
0
LTYPE
5
16
330
6
100
AcDbSymbolTableRecord
100
AcDbLinetypeTableRecord
2
ByBlock
70
0
3

72
65
73
0
40
0.0
0
ENDTAB
0
TABLE
2
LAYER
5
5
330
0
100
AcDbSymbolTable
70
3
0
LAYER
5
13
330
5
100
AcDbSymbolTableRecord
100
AcDbLayerTableRecord
2
0
70
0
62
7
6
Continuous
290
1
370
-3
390
0
0
LAYER
5
22
330
5
100
AcDbSymbolTableRecord
100
AcDbLayerTableRecord
2
Layout
70
0
62
7
6
Continuous
290
1
370
-3
390
0
0
LAYER
5
4B
330
5
100
AcDbSymbolTableRecord
100
AcDbLayerTableRecord
2
dim
70
0
62
7
6
Continuous
290
1
370
-3
390
0
0
ENDTAB
0
TABLE
2
STYLE
5
7
330
0
100
AcDbSymbolTable
70
1
0
STYLE
5
17
330
7
100
AcDbSymbolTableRecord
100
AcDbTextStyleTableRecord
2
Standard
3
simplex.shx
70
0
71
0
40
0.0
41
1.0
42
0.0
50
0.0
0
ENDTAB
0
TABLE
2
DIMSTYLE
5
9
330
0
100
AcDbSymbolTable
70
1
100
AcDbDimStyleTable
0
DIMSTYLE
105
19
330
9
100
AcDbSymbolTableRecord
100
AcDbDimStyleTableRecord
2
Standard
3
<>
4
[]
40
1.0
41
0.18
42
0.0625
43
0.38
44
0.18
45
0.0
46
0.0
47
0.0
49
1.0
70
0
71
0
72
0
73
0
74
0
75
0
76
0
77
0
78
0
79
0
140
0.18
141
0.09
143
25.4
144
1.0
146
1.0
147
0.09
148
0.0
170
0
171
2
172
0
174
0
175
1
176
0
177
0
178
0
179
0
271
4
272
4
273
2
274
2
275
0
276
0
277
2
278
46
279
0
280
0
281
0
282
0
283
1
284
0
285
0
286
0
289
3
290
0
294
0
340
17
173
0
345
16
346
16
347
16
371
-2
372
-2
0
ENDTAB
0
TABLE
2
VIEW
5
3
330
0
100
AcDbSymbolTable
70
0
0
ENDTAB
0
TABLE
2
UCS
5
B
330
0
100
AcDbSymbolTable
70
0
0
ENDTAB
0
TABLE
2
BLOCK_RECORD
5
C
330
0
100
AcDbSymbolTable
70
2
0
BLOCK_RECORD
5
1B
330
C
100
AcDbSymbolTableRecord
100
AcDbBlockTableRecord
2
*Model_Space
340
1F
0
BLOCK_RECORD
5
4C
330
C
100
AcDbSymbolTableRecord
100
AcDbBlockTableRecord
2
*Paper_Space
340
51
0
ENDTAB
0
ENDSEC
0
SECTION
2
BLOCKS
0
BLOCK
5
1D
330
1B
100
AcDbEntity
67
0
8
0
100
AcDbBlockBegin
2
*Model_Space
70
0
10
0.0
20
0.0
30
0.0
3
*Model_Space
0
ENDBLK
5
1C
330
1B
100
AcDbEntity
8
0
100
AcDbBlockEnd
0
BLOCK
5
4E
330
4C
100
AcDbEntity
67
1
8
0
100
AcDbBlockBegin
2
*Paper_Space
70
0
10
0.0
20
0.0
30
0.0
3
*Paper_Space
0
ENDBLK
5
4D
330
4C
100
AcDbEntity
8
0
100
AcDbBlockEnd
0
ENDSEC
0
SECTION
2
ENTITIES
0
3DFACE
5
21
330
1B
100
AcDbEntity
67
0
8
Layout
62
51
420
16119260
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbFace
10
240.0
20
233.0
30
0.0
11
0.0
21
233.0
31
0.0
12
0.0
22
240.0
32
0.0
13
240.0
23
240.0
33
0.0
70
0
0
3DFACE
5
23
330
1B
100
AcDbEntity
67
0
8
Layout
62
51
420
16119260
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbFace
10
233.0
20
0.0
30
0.0
11
233.0
21
240.0
31
0.0
12
240.0
22
240.0
32
0.0
13
240.0
23
0.0
33
0.0
70
0
0
3DFACE
5
24
330
1B
100
AcDbEntity
67
0
8
Layout
62
51
420
16119260
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbFace
10
0.0
20
7.0
30
0.0
11
240.0
21
7.0
31
0.0
12
240.0
22
0.0
32
0.0
13
0.0
23
0.0
33
0.0
70
0
0
3DFACE
5
25
330
1B
100
AcDbEntity
67
0
8
Layout
62
51
420
16119260
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbFace
10
7.0
20
240.0
30
0.0
11
7.0
21
0.0000000000005116
31
0.0
12
0.0
22
0.0000000000005116
32
0.0
13
0.0
23
240.0
33
0.0
70
0
0
LINE
5
26
330
1B
100
AcDbEntity
67
0
8
Layout
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
240.0
20
233.0
30
0.0
11
0.0
21
233.0
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
LINE
5
27
330
1B
100
AcDbEntity
67
0
8
Layout
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
0.0
20
233.0
30
0.0
11
0.0
21
240.0
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
LINE
5
28
330
1B
100
AcDbEntity
67
0
8
Layout
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
0.0
20
240.0
30
0.0
11
240.0
21
240.0
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
LINE
5
29
330
1B
100
AcDbEntity
67
0
8
Layout
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
240.0
20
240.0
30
0.0
11
240.0
21
233.0
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
TEXT
5
2A
330
1B
100
AcDbEntity
67
0
8
Layout
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbText
1
EXT-1
10
120.0
20
236.5
30
0.0
40
1.5
41
1.0
50
0.0
51
0.0
7
Standard
11
120.0
21
236.5
31
0.0
210
0.0
220
0.0
230
1.0
72
4
100
AcDbText
73
0
0
LINE
5
2B
330
1B
100
AcDbEntity
67
0
8
Layout
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
233.0
20
0.0
30
0.0
11
233.0
21
240.0
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
LINE
5
2C
330
1B
100
AcDbEntity
67
0
8
Layout
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
233.0
20
240.0
30
0.0
11
240.0
21
240.0
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
LINE
5
2D
330
1B
100
AcDbEntity
67
0
8
Layout
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
240.0
20
240.0
30
0.0
11
240.0
21
0.0
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
LINE
5
2E
330
1B
100
AcDbEntity
67
0
8
Layout
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
240.0
20
0.0
30
0.0
11
233.0
21
0.0
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
TEXT
5
2F
330
1B
100
AcDbEntity
67
0
8
Layout
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbText
1
EXT-2
10
236.5
20
120.0
30
0.0
40
1.5
41
1.0
50
90.0
51
0.0
7
Standard
11
236.5
21
120.0
31
0.0
210
0.0
220
0.0
230
1.0
72
4
100
AcDbText
73
0
0
LINE
5
30
330
1B
100
AcDbEntity
67
0
8
Layout
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
0.0
20
7.0
30
0.0
11
240.0
21
7.0
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
LINE
5
31
330
1B
100
AcDbEntity
67
0
8
Layout
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
240.0
20
7.0
30
0.0
11
240.0
21
0.0
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
LINE
5
32
330
1B
100
AcDbEntity
67
0
8
Layout
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
240.0
20
0.0
30
0.0
11
0.0
21
0.0
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
LINE
5
33
330
1B
100
AcDbEntity
67
0
8
Layout
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
0.0
20
0.0
30
0.0
11
0.0
21
7.0
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
TEXT
5
34
330
1B
100
AcDbEntity
67
0
8
Layout
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbText
1
EXT-3
10
120.0
20
3.5
30
0.0
40
1.5
41
1.0
50
0.0
51
0.0
7
Standard
11
120.0
21
3.5
31
0.0
210
0.0
220
0.0
230
1.0
72
4
100
AcDbText
73
0
0
LINE
5
35
330
1B
100
AcDbEntity
67
0
8
Layout
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
7.0
20
240.0
30
0.0
11
7.0
21
0.0000000000005116
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
LINE
5
36
330
1B
100
AcDbEntity
67
0
8
Layout
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
7.0
20
0.0000000000005116
30
0.0
11
0.0
21
0.0000000000005116
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
LINE
5
37
330
1B
100
AcDbEntity
67
0
8
Layout
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
0.0
20
0.0000000000005116
30
0.0
11
0.0
21
240.0
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
LINE
5
38
330
1B
100
AcDbEntity
67
0
8
Layout
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
0.0
20
240.0
30
0.0
11
7.0
21
240.0
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
TEXT
5
39
330
1B
100
AcDbEntity
67
0
8
Layout
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbText
1
EXT-4
10
3.5
20
120.0
30
0.0
40
1.5
41
1.0
50
90.0
51
0.0
7
Standard
11
3.5
21
120.0
31
0.0
210
0.0
220
0.0
230
1.0
72
4
100
AcDbText
73
0
0
TEXT
5
3A
330
1B
100
AcDbEntity
67
0
8
Layout
62
195
420
5263440
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbText
1
20'
10
120.0
20
242.0
30
0.0
40
1.25
41
1.0
50
0.0
51
0.0
7
Standard
11
120.0
21
242.0
31
0.0
210
0.0
220
0.0
230
1.0
72
1
100
AcDbText
73
1
0
TEXT
5
3B
330
1B
100
AcDbEntity
67
0
8
Layout
62
195
420
5263440
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbText
1
20'
10
242.0
20
120.0
30
0.0
40
1.25
41
1.0
50
270.0
51
0.0
7
Standard
11
242.0
21
120.0
31
0.0
210
0.0
220
0.0
230
1.0
72
1
100
AcDbText
73
1
0
TEXT
5
3C
330
1B
100
AcDbEntity
67
0
8
Layout
62
195
420
5263440
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbText
1
20'
10
120.0
20
-1.5
30
0.0
40
1.25
41
1.0
50
0.0
51
0.0
7
Standard
11
120.0
21
-1.5
31
0.0
210
0.0
220
0.0
230
1.0
72
1
100
AcDbText
73
3
0
TEXT
5
3D
330
1B
100
AcDbEntity
67
0
8
Layout
62
195
420
5263440
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbText
1
20'
10
-2.0
20
120.0
30
0.0
40
1.25
41
1.0
50
90.0
51
0.0
7
Standard
11
-2.0
21
120.0
31
0.0
210
0.0
220
0.0
230
1.0
72
1
100
AcDbText
73
1
0
LINE
5
3E
330
1B
100
AcDbEntity
67
0
8
Layout
62
195
420
5263440
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
-30.5
20
0.0
30
0.0
11
-30.5
21
240.0
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
LINE
5
3F
330
1B
100
AcDbEntity
67
0
8
Layout
62
195
420
5263440
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
-7.0
20
0.0
30
0.0
11
-42.25
21
0.0
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
LINE
5
40
330
1B
100
AcDbEntity
67
0
8
Layout
62
195
420
5263440
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
-7.0
20
240.0
30
0.0
11
-42.25
21
240.0
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
LINE
5
41
330
1B
100
AcDbEntity
67
0
8
Layout
62
195
420
5263440
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
-28.5416666666667
20
-1.95833333333333
30
0.0
11
-32.4583333333333
21
1.95833333333333
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
LINE
5
42
330
1B
100
AcDbEntity
67
0
8
Layout
62
195
420
5263440
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
-28.5416666666667
20
238.041666666667
30
0.0
11
-32.4583333333333
21
241.958333333333
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
TEXT
5
43
330
1B
100
AcDbEntity
67
0
8
Layout
62
195
420
5263440
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbText
1
20'
10
-31.5
20
120.0
30
0.0
40
1.25
41
1.0
50
90.0
51
0.0
7
Standard
11
-31.5
21
120.0
31
0.0
210
0.0
220
0.0
230
1.0
72
1
100
AcDbText
73
1
0
LINE
5
44
330
1B
100
AcDbEntity
67
0
8
Layout
62
195
420
5263440
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
240.0
20
-30.5
30
0.0
11
0.0
21
-30.5
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
LINE
5
45
330
1B
100
AcDbEntity
67
0
8
Layout
62
195
420
5263440
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
240.0
20
-7.0
30
0.0
11
240.0
21
-42.25
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
LINE
5
46
330
1B
100
AcDbEntity
67
0
8
Layout
62
195
420
5263440
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
0.0
20
-7.0
30
0.0
11
0.0
21
-42.25
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
LINE
5
47
330
1B
100
AcDbEntity
67
0
8
Layout
62
195
420
5263440
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
241.958333333333
20
-28.5416666666667
30
0.0
11
238.041666666667
21
-32.4583333333333
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
LINE
5
48
330
1B
100
AcDbEntity
67
0
8
Layout
62
195
420
5263440
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbLine
10
1.95833333333333
20
-28.5416666666667
30
0.0
11
-1.95833333333333
21
-32.4583333333333
31
0.0
39
0.0
210
0.0
220
0.0
230
1.0
0
TEXT
5
49
330
1B
100
AcDbEntity
67
0
8
Layout
62
195
420
5263440
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbText
1
20'
10
120.0
20
-31.0
30
0.0
40
1.25
41
1.0
50
0.0
51
0.0
7
Standard
11
120.0
21
-31.0
31
0.0
210
0.0
220
0.0
230
1.0
72
1
100
AcDbText
73
3
0
TEXT
5
4A
330
1B
100
AcDbEntity
67
0
8
dim
62
7
420
16777215
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbText
1
20'x20'
10
120.0
20
120.0
30
0.0
40
1.5
41
1.0
50
0.0
51
0.0
7
Standard
11
120.0
21
120.0
31
0.0
210
0.0
220
0.0
230
1.0
72
4
100
AcDbText
73
0
0
VIEWPORT
5
50
330
4C
100
AcDbEntity
67
1
8
0
62
256
6
ByLayer
370
-1
48
1.0
60
0
100
AcDbViewport
10
0.0
20
0.0
30
0.0
40
297.0
41
210.0
68
1
69
1
12
50.0
22
100.0
13
0.0
23
0.0
14
10.0
24
10.0
15
10.0
25
10.0
16
0.0
26
0.0
36
1.0
17
0.0
27
0.0
37
0.0
42
50.0
43
0.0
44
0.0
45
250.0
50
0.0
51
0.0
72
1000
90
819232
110
0.0
120
0.0
130
0.0
111
1.0
121
0.0
131
0.0
112
0.0
122
1.0
132
0.0
0
ENDSEC
0
SECTION
2
OBJECTS
0
DICTIONARY
5
55
330
0
100
AcDbDictionary
280
0
281
1
3
ACAD_GROUP
350
56
3
ACAD_LAYOUT
350
57
3
ACAD_MLINESTYLE
350
5B
0
DICTIONARY
5
56
330
55
100
AcDbDictionary
280
0
281
1
0
DICTIONARY
5
57
330
55
100
AcDbDictionary
280
0
281
1
3
Model
350
1F
3
Layout1
350
51
0
DICTIONARY
5
5B
330
55
100
AcDbDictionary
280
0
281
1
3
Standard
350
1A
0
LAYOUT
5
1F
330
57
100
AcDbPlotSettings
1

2
none_device
4
ISO_A4_(210.00_x_297.00_MM)
6

40
7.5
41
20.0
42
7.5
43
20.0
44
210.0
45
297.0
46
0.0
47
0.0
48
0.0
49
0.0
140
0.0
141
0.0
142
1.0
143
1.0
70
11952
72
1
73
1
74
1
7

75
0
76
0
77
2
78
300
147
1.0
148
0.0
149
0.0
100
AcDbLayout
1
Model
70
1
71
0
10
-20.0
20
-7.5
11
277.0
21
202.5
12
0.0
22
0.0
32
0.0
14
25.7
24
19.5
34
0.0
15
231.3
25
175.5
35
0.0
146
0.0
13
0.0
23
0.0
33
0.0
16
1.0
26
0.0
36
0.0
17
0.0
27
1.0
37
0.0
76
0
330
1B
0
LAYOUT
5
51
330
57
100
AcDbPlotSettings
1

2
none_device
4
ISO_A4_(210.00_x_297.00_MM)
6

40
7.5
41
20.0
42
7.5
43
20.0
44
210.0
45
297.0
46
0.0
47
0.0
48
0.0
49
0.0
140
0.0
141
0.0
142
1.0
143
1.0
70
688
72
1
73
1
74
1
7

75
0
76
0
77
2
78
300
147
1.0
148
0.0
149
0.0
100
AcDbLayout
1
Layout1
70
1
71
1
10
-20.0
20
-7.5
11
277.0
21
202.5
12
0.0
22
0.0
32
0.0
14
25.7
24
19.5
34
0.0
15
231.3
25
175.5
35
0.0
146
0.0
13
0.0
23
0.0
33
0.0
16
1.0
26
0.0
36
0.0
17
0.0
27
1.0
37
0.0
76
0
330
4C
0
MLINESTYLE
5
1A
330
5B
100
AcDbMlineStyle
2
Standard
70
0
3

62
256
51
90.0
52
90.0
71
2
49
-0.5
62
256
6
ByLayer
49
0.5
62
256
6
ByLayer
0
ENDSEC
0
EOF
`;
};

/**
 * Create the DXF file footer
 * 
 * @returns {String} - DXF footer section
 */
export const createDXFFooter = () => {
  return `0
ENDSEC
0
SECTION
2
OBJECTS
0
ENDSEC
0
EOF
`;
};

/**
 * Apply 3D transformations to points
 * 
 * @param {Array} points - Array of [x,y,z] point coordinates
 * @param {Array} position - [x,y,z] position offset
 * @param {Array} rotation - [x,y,z] rotation in radians
 * @returns {Array} - Transformed points
 */
const applyTransformation = (points, position, rotation) => {
  // Create a transformation matrix
  const matrix = new THREE.Matrix4();
  
  // Apply position offset
  matrix.makeTranslation(position[0], position[1], position[2]);
  
  // Create rotation matrices
  const rotationX = new THREE.Matrix4().makeRotationX(rotation[0]);
  const rotationY = new THREE.Matrix4().makeRotationY(rotation[1]);
  const rotationZ = new THREE.Matrix4().makeRotationZ(rotation[2]);
  
  // Combine all transformations
  matrix.multiply(rotationX).multiply(rotationY).multiply(rotationZ);
  
  // Apply transformation to all points
  return points.map(point => {
    const vector = new THREE.Vector3(point[0], point[1], point[2]);
    vector.applyMatrix4(matrix);
    return [vector.x, vector.y, vector.z];
  });
};

/**
 * Create DXF entities for a square panel
 * 
 * @param {String} label - Panel label (EX-1, EX-3)
 * @param {Array} position - [x,y,z] position
 * @param {Array} rotation - [x,y,z] rotation in radians
 * @param {Number} size - Panel size
 * @param {Number} thickness - Panel thickness
 * @returns {String} - DXF entities for square panel
 */
const createSquarePanelDXF = (label, position, rotation, size, thickness) => {
  // Generate square panel geometry
  const halfSize = size / 2;
  const height = size * 0.75;
  const halfHeight = height / 2;
  
  // Define panel faces as 3D points
  const topFace = [
    [-halfSize, -halfHeight, thickness],
    [halfSize, -halfHeight, thickness],
    [halfSize, halfHeight, thickness],
    [-halfSize, halfHeight, thickness],
    [-halfSize, -halfHeight, thickness], // Close the loop
  ];
  
  const bottomFace = [
    [-halfSize, -halfHeight, 0],
    [halfSize, -halfHeight, 0],
    [halfSize, halfHeight, 0],
    [-halfSize, halfHeight, 0],
    [-halfSize, -halfHeight, 0], // Close the loop
  ];
  
  // Apply transformations
  const transformedTopFace = applyTransformation(topFace, position, rotation);
  const transformedBottomFace = applyTransformation(bottomFace, position, rotation);
  
  // Create DXF content for the panel
  let dxfContent = '';
  
  // Add top face
  dxfContent += createPolyline(transformedTopFace, 'PANELS');
  
  // Add bottom face
  dxfContent += createPolyline(transformedBottomFace, 'PANELS');
  
  // Add side edges to connect top and bottom faces
  for (let i = 0; i < 4; i++) {
    dxfContent += createLine(
      transformedTopFace[i],
      transformedBottomFace[i],
      'PANELS'
    );
  }
  
  // Add panel label
  const labelPosition = calculateCentroid(transformedTopFace.slice(0, 4));
  dxfContent += createText(label, labelPosition, 0.5, 'PANELS');
  
  return dxfContent;
};

/**
 * Create DXF entities for a pentagon panel
 * 
 * @param {String} label - Panel label (EX-2, EX-4)
 * @param {Array} position - [x,y,z] position
 * @param {Array} rotation - [x,y,z] rotation in radians
 * @param {Number} size - Panel size
 * @param {Number} thickness - Panel thickness
 * @returns {String} - DXF entities for pentagon panel
 */
const createPentagonPanelDXF = (label, position, rotation, size, thickness) => {
  // Generate pentagon panel geometry
  const halfSize = size / 2;
  const height = size;
  
  // Define pentagon points based on the PentagonPanel component
  const topFace = [
    [-halfSize, -height/2, thickness],  // Bottom left
    [halfSize, -height/2, thickness],   // Bottom right
    [halfSize, height/4, thickness],    // Right middle
    [0, height/2, thickness],           // Top center
    [-halfSize, height/4, thickness],   // Left middle
    [-halfSize, -height/2, thickness],  // Close the loop
  ];
  
  const bottomFace = [
    [-halfSize, -height/2, 0],  // Bottom left
    [halfSize, -height/2, 0],   // Bottom right
    [halfSize, height/4, 0],    // Right middle
    [0, height/2, 0],           // Top center
    [-halfSize, height/4, 0],   // Left middle
    [-halfSize, -height/2, 0],  // Close the loop
  ];
  
  // Apply transformations
  const transformedTopFace = applyTransformation(topFace, position, rotation);
  const transformedBottomFace = applyTransformation(bottomFace, position, rotation);
  
  // Create DXF content for the panel
  let dxfContent = '';
  
  // Add top face
  dxfContent += createPolyline(transformedTopFace, 'PANELS');
  
  // Add bottom face
  dxfContent += createPolyline(transformedBottomFace, 'PANELS');
  
  // Add side edges to connect top and bottom faces
  for (let i = 0; i < 5; i++) {
    dxfContent += createLine(
      transformedTopFace[i],
      transformedBottomFace[i],
      'PANELS'
    );
  }
  
  // Add panel label
  const labelPosition = calculateCentroid(transformedTopFace.slice(0, 5));
  dxfContent += createText(label, labelPosition, 0.5, 'PANELS');
  
  return dxfContent;
};

/**
 * Create a DXF polyline entity
 * 
 * @param {Array} points - Array of [x,y,z] coordinates
 * @param {String} layer - Layer name
 * @returns {String} - DXF polyline definition
 */
const createPolyline = (points, layer) => {
  let dxfContent = `0
POLYLINE
8
${layer}
66
1
70
0
`;

  // Add vertices
  points.forEach(point => {
    dxfContent += `0
VERTEX
8
${layer}
10
${point[0].toFixed(6)}
20
${point[1].toFixed(6)}
30
${point[2].toFixed(6)}
`;
  });

  // Close the polyline
  dxfContent += `0
SEQEND
8
${layer}
`;

  return dxfContent;
};

/**
 * Create a DXF line entity
 * 
 * @param {Array} start - [x,y,z] start point
 * @param {Array} end - [x,y,z] end point
 * @param {String} layer - Layer name
 * @returns {String} - DXF line definition
 */
const createLine = (start, end, layer) => {
  return `0
LINE
8
${layer}
10
${start[0].toFixed(6)}
20
${start[1].toFixed(6)}
30
${start[2].toFixed(6)}
11
${end[0].toFixed(6)}
21
${end[1].toFixed(6)}
31
${end[2].toFixed(6)}
`;
};

/**
 * Create a DXF text entity
 * 
 * @param {String} text - Text content
 * @param {Array} position - [x,y,z] position
 * @param {Number} height - Text height
 * @param {String} layer - Layer name
 * @returns {String} - DXF text definition
 */
const createText = (text, position, height, layer) => {
  return `0
TEXT
8
${layer}
10
${position[0].toFixed(6)}
20
${position[1].toFixed(6)}
30
${position[2].toFixed(6)}
40
${height}
1
${text}
7
STANDARD
`;
};

/**
 * Calculate the centroid of a set of points
 * 
 * @param {Array} points - Array of [x,y,z] points
 * @returns {Array} - [x,y,z] centroid coordinates
 */
const calculateCentroid = (points) => {
  const numPoints = points.length;
  let sumX = 0, sumY = 0, sumZ = 0;
  
  points.forEach(point => {
    sumX += point[0];
    sumY += point[1];
    sumZ += point[2];
  });
  
  return [sumX / numPoints, sumY / numPoints, sumZ / numPoints];
};

/**
 * Create and trigger download of DXF file
 * 
 * @param {String} dxfContent - DXF file content
 * @param {String} filename - Name for the download file
 */
export const downloadDXF = (dxfContent, filename) => {
  const blob = new Blob([dxfContent], { type: 'application/dxf' });
  const url = URL.createObjectURL(blob);
  
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  // Clean up
  setTimeout(() => {
    URL.revokeObjectURL(url);
  }, 100);
  
  console.log(`DXF export completed: ${filename}`);
};